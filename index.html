<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Asset Management System</title>
    <!-- Chart.js for Graphical Representation -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #0ea5e9;
            --primary-dark: #0284c7;
            --secondary: #64748b;
            --bg-dark: #0f172a;
            --card-dark: rgba(255, 255, 255, 0.05);
            --text-light: #f1f5f9;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            min-height: 100vh;
            background: linear-gradient(135deg, #0f172a 0%, #1e3a8a 50%, #0f172a 100%);
            color: white;
            overflow-x: hidden;
        }

        /* --- Scrollbar --- */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 4px; }

        /* --- Login Styles --- */
        .login-page {
            position: fixed; inset: 0; z-index: 100;
            display: flex; justify-content: center; align-items: center;
            background: #0f172a;
            background-image: radial-gradient(circle at 50% 50%, #1e3a8a 0%, #0f172a 70%);
        }
        .login-page.hidden { display: none; }
        
        .login-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            padding: 2.5rem; border-radius: 1.5rem;
            width: 100%; max-width: 450px;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
        }

        .form-group { margin-bottom: 1.25rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-size: 0.9rem; color: #94a3b8; }
        .form-input {
            width: 100%; padding: 0.75rem;
            background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 0.5rem; color: white; outline: none; transition: 0.3s;
        }
        .form-input:focus { border-color: var(--primary); }

        .btn {
            width: 100%; padding: 0.875rem; border: none; border-radius: 0.5rem;
            background: linear-gradient(to right, var(--primary), #2563eb);
            color: white; font-weight: 600; cursor: pointer; transition: 0.3s;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(14, 165, 233, 0.3); }
        .btn-danger { background: linear-gradient(to right, #ef4444, #b91c1c); }
        .btn-success { background: linear-gradient(to right, #10b981, #059669); }
        
        .toggle-links { display: flex; justify-content: space-between; margin-top: 1rem; font-size: 0.85rem; }
        .toggle-links a { color: #7dd3fc; cursor: pointer; text-decoration: none; }

        /* --- Dashboard Layout --- */
        .dashboard { display: none; min-height: 100vh; }
        .dashboard.active { display: flex; }

        /* Sidebar */
        .sidebar {
            width: 260px; background: rgba(0,0,0,0.3);
            backdrop-filter: blur(10px); border-right: 1px solid rgba(255,255,255,0.1);
            display: flex; flex-direction: column; padding: 1.5rem;
            position: fixed; top: 0; bottom: 0; left: 0; z-index: 50;
        }
        
        .brand { font-size: 1.5rem; font-weight: bold; margin-bottom: 2rem; display: flex; align-items: center; gap: 0.5rem; }
        
        .nav-item {
            padding: 0.75rem 1rem; margin-bottom: 0.5rem;
            border-radius: 0.5rem; cursor: pointer; color: #94a3b8;
            transition: 0.3s; display: flex; align-items: center; gap: 0.75rem;
        }
        .nav-item:hover, .nav-item.active { background: rgba(255,255,255,0.1); color: white; }
        .nav-item.active { border-left: 3px solid var(--primary); }

        /* Main Content */
        .main-content { margin-left: 260px; flex: 1; padding: 2rem; width: calc(100% - 260px); }

        .top-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        /* Cards & Grid */
        .stats-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem; margin-bottom: 2rem;
        }
        .stat-card {
            background: var(--card-dark); padding: 1.5rem; border-radius: 1rem;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .stat-val { font-size: 2rem; font-weight: bold; margin-top: 0.5rem; }

        /* Tables & Lists */
        .table-container {
            background: var(--card-dark); border-radius: 1rem;
            overflow: hidden; border: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 2rem;
        }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 1rem; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.05); }
        th { background: rgba(0,0,0,0.2); font-weight: 600; color: #94a3b8; }
        tr:hover { background: rgba(255,255,255,0.02); }

        /* Badges */
        .badge { padding: 0.25rem 0.75rem; border-radius: 99px; font-size: 0.75rem; font-weight: 600; }
        .badge-avail { background: rgba(16, 185, 129, 0.2); color: #6ee7b7; }
        .badge-busy { background: rgba(59, 130, 246, 0.2); color: #93c5fd; }
        .badge-bad { background: rgba(239, 68, 68, 0.2); color: #fca5a5; }
        .badge-warn { background: rgba(245, 158, 11, 0.2); color: #fcd34d; }

        /* Modals */
        .modal {
            display: none; position: fixed; inset: 0; z-index: 200;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(5px);
            justify-content: center; align-items: center;
        }
        .modal.show { display: flex; }
        .modal-content {
            background: #1e293b; padding: 2rem; border-radius: 1rem;
            width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto;
            border: 1px solid rgba(255,255,255,0.1);
        }

        /* Chart Container */
        .chart-wrapper {
            background: var(--card-dark); padding: 1.5rem; border-radius: 1rem;
            height: 400px; display: flex; justify-content: center;
            border: 1px solid rgba(255,255,255,0.1);
        }

        /* Content Sections */
        .section { display: none; }
        .section.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .action-btn {
            padding: 0.4rem 0.8rem; border-radius: 0.4rem; border: none;
            cursor: pointer; font-size: 0.8rem; margin-right: 0.3rem; color: white;
        }
        .btn-blue { background: rgba(59, 130, 246, 0.3); color: #93c5fd; }
        .btn-blue:hover { background: rgba(59, 130, 246, 0.5); }
    </style>
</head>
<body>

    <!-- LOGIN PAGE -->
    <div class="login-page" id="loginPage">
        <div class="login-card">
            <div style="text-align: center; margin-bottom: 2rem;">
                <h1 style="font-size: 2rem;">üè¢ AssetPro</h1>
                <p style="color: #94a3b8;">Enterprise Asset Management</p>
            </div>
            
            <div id="loginForm">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" class="form-input" id="loginUser" placeholder="Enter username">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" class="form-input" id="loginPass" placeholder="Enter password">
                </div>
                <button class="btn" onclick="handleLogin()">Login</button>
                <div class="toggle-links">
                    <a onclick="toggleForms('register')">Create Account</a>
                    <span style="color: #64748b; font-size: 0.8rem;">Demo: admin/admin123</span>
                </div>
            </div>

            <div id="registerForm" style="display: none;">
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" class="form-input" id="regName">
                </div>
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" class="form-input" id="regUser">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" class="form-input" id="regPass">
                </div>
                <div class="form-group">
                    <label>Role</label>
                    <select class="form-input" id="regRole">
                        <option value="employee">Employee</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <button class="btn btn-success" onclick="handleRegister()">Register</button>
                <div class="toggle-links">
                    <a onclick="toggleForms('login')">‚Üê Back to Login</a>
                </div>
            </div>
        </div>
    </div>

    <!-- DASHBOARD -->
    <div class="dashboard" id="dashboard">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="brand">üè¢ AssetPro</div>
            
            <div id="sidebarMenu">
                <!-- Links injected via JS based on Role -->
            </div>

            <div style="margin-top: auto;">
                <div class="nav-item" onclick="logout()">
                    üö™ Logout
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <div class="top-header">
                <div>
                    <h2 id="pageTitle">Dashboard</h2>
                    <p style="color: #94a3b8;" id="welcomeText">Welcome back</p>
                </div>
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <span class="badge badge-avail" id="userRoleBadge">ROLE</span>
                    <div style="width: 40px; height: 40px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                        <span id="userInitials">U</span>
                    </div>
                </div>
            </div>

            <!-- SECTIONS -->

            <!-- 1. DASHBOARD HOME (Admin) -->
            <div id="sec-dashboard" class="section">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div style="color: #94a3b8;">Total Assets</div>
                        <div class="stat-val" id="statTotal">0</div>
                    </div>
                    <div class="stat-card">
                        <div style="color: #94a3b8;">Assigned</div>
                        <div class="stat-val" style="color: var(--warning)" id="statAssigned">0</div>
                    </div>
                    <div class="stat-card">
                        <div style="color: #94a3b8;">Available</div>
                        <div class="stat-val" style="color: var(--success)" id="statAvail">0</div>
                    </div>
                    <div class="stat-card">
                        <div style="color: #94a3b8;">Pending Requests</div>
                        <div class="stat-val" style="color: var(--danger)" id="statRequests">0</div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem;">
                    <div class="chart-wrapper">
                        <canvas id="assetChart"></canvas>
                    </div>
                    <div class="stat-card">
                        <h3>Quick Actions</h3>
                        <div style="margin-top: 1rem; display: flex; flex-direction: column; gap: 1rem;">
                            <button class="btn" onclick="openAssetModal()">+ Add New Asset</button>
                            <button class="btn btn-blue" onclick="navTo('sec-users')">Manage Users</button>
                            <button class="btn btn-blue" onclick="navTo('sec-requests')">View Requests</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. INVENTORY (Admin/View) -->
            <div id="sec-inventory" class="section">
                <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                    <h3>All Assets</h3>
                    <input type="text" class="form-input" style="width: 250px;" placeholder="Search assets..." onkeyup="renderInventory(this.value)">
                </div>
                <div class="table-container">
                    <table id="inventoryTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Category</th>
                                <th>Status</th>
                                <th>Assigned To</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody><!-- JS fills this --></tbody>
                    </table>
                </div>
            </div>

            <!-- 3. MY ASSETS (Employee) -->
            <div id="sec-myassets" class="section">
                <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                    <h3>My Possessions</h3>
                    <button class="btn" style="width: auto;" onclick="openRequestModal('issue')">+ Request New Asset</button>
                </div>
                <div class="table-container">
                    <table id="myAssetsTable">
                        <thead>
                            <tr>
                                <th>Asset Name</th>
                                <th>Date Assigned</th>
                                <th>Condition</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody><!-- JS fills this --></tbody>
                    </table>
                </div>
            </div>

            <!-- 4. REQUESTS (Admin/Employee View) -->
            <div id="sec-requests" class="section">
                <h3>Asset Requests</h3>
                <div class="table-container">
                    <table id="requestsTable">
                        <thead>
                            <tr>
                                <th>Employee</th>
                                <th>Type</th>
                                <th>Asset/Reason</th>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody><!-- JS fills this --></tbody>
                    </table>
                </div>
            </div>

             <!-- 5. USERS (Admin) -->
             <div id="sec-users" class="section">
                <h3>User Management</h3>
                <p style="color: #94a3b8; margin-bottom: 1rem; font-size: 0.9rem;">
                    Note: New Admin accounts require approval from an existing Admin.
                </p>
                <div class="table-container">
                    <table id="usersTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Username</th>
                                <th>Role</th>
                                <th>Assets Held</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody><!-- JS fills this --></tbody>
                    </table>
                </div>
            </div>

            <!-- 6. PROFILE -->
            <div id="sec-profile" class="section">
                <div class="stat-card" style="max-width: 600px;">
                    <h3>My Profile</h3>
                    <div style="margin-top: 1.5rem;">
                        <div class="form-group">
                            <label>Full Name</label>
                            <input type="text" class="form-input" id="profileName">
                        </div>
                        <div class="form-group">
                            <label>Change Password</label>
                            <input type="password" class="form-input" id="profilePass" placeholder="New Password">
                        </div>
                        <button class="btn" onclick="updateProfile()">Update Profile</button>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- MODALS -->

    <!-- Asset Form Modal -->
    <div class="modal" id="assetModal">
        <div class="modal-content">
            <h3 style="margin-bottom: 1.5rem;">Manage Asset</h3>
            <input type="hidden" id="assetId">
            <div class="form-group">
                <label>Asset Name</label>
                <input type="text" class="form-input" id="assetName">
            </div>
            <div class="form-group">
                <label>Category</label>
                <select class="form-input" id="assetType">
                    <option value="Laptop">Laptop</option>
                    <option value="Phone">Phone</option>
                    <option value="Furniture">Furniture</option>
                    <option value="Accessory">Accessory</option>
                </select>
            </div>
            <div class="form-group">
                <label>Status</label>
                <select class="form-input" id="assetStatus">
                    <option value="Available">Available</option>
                    <option value="In-Use">In-Use</option>
                    <option value="Damaged">Damaged</option>
                    <option value="Maintenance">Maintenance</option>
                    <option value="Lost">Lost</option>
                </select>
            </div>
            <div style="display: flex; gap: 1rem;">
                <button class="btn" onclick="saveAsset()">Save Asset</button>
                <button class="btn btn-danger" onclick="closeModal('assetModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Assign Asset Modal -->
    <div class="modal" id="assignModal">
        <div class="modal-content">
            <h3>Assign Asset</h3>
            <p id="assignAssetName" style="color: var(--primary); margin-bottom: 1rem;"></p>
            <input type="hidden" id="assignAssetId">
            <div class="form-group">
                <label>Select Employee</label>
                <select class="form-input" id="assignUserSelect"></select>
            </div>
            <button class="btn" onclick="processAssignment()">Assign</button>
            <button class="btn btn-danger" style="margin-top: 0.5rem" onclick="closeModal('assignModal')">Cancel</button>
        </div>
    </div>

    <!-- Request/Return Modal -->
    <div class="modal" id="requestModal">
        <div class="modal-content">
            <h3 id="reqModalTitle">Request</h3>
            <input type="hidden" id="reqType"> <!-- issue or return -->
            <input type="hidden" id="reqAssetId"> <!-- for returns -->
            
            <div class="form-group" id="reqAssetGroup">
                <label>Asset Name / Category</label>
                <input type="text" class="form-input" id="reqAssetName" placeholder="E.g. Macbook Pro M1">
            </div>
            
            <div class="form-group">
                <label>Reason / Condition Details</label>
                <textarea class="form-input" id="reqReason" rows="3"></textarea>
            </div>

            <button class="btn" onclick="submitRequest()">Submit Request</button>
            <button class="btn btn-danger" style="margin-top: 0.5rem" onclick="closeModal('requestModal')">Cancel</button>
        </div>
    </div>

    <!-- History/Log Modal -->
    <div class="modal" id="historyModal">
        <div class="modal-content" style="max-width: 600px;">
            <h3>Asset History</h3>
            <div style="margin-top: 1rem; max-height: 300px; overflow-y: auto;" id="historyContent">
                <!-- Logs go here -->
            </div>
            <button class="btn btn-danger" style="margin-top: 1rem" onclick="closeModal('historyModal')">Close</button>
        </div>
    </div>

    <script>
        // --- DATA STORE ---
        let users = JSON.parse(localStorage.getItem('ams_users')) || [
            { id: 1, name: 'System Admin', username: 'admin', password: 'admin123', role: 'admin', isApproved: true }
        ];
        let assets = JSON.parse(localStorage.getItem('ams_assets')) || [];
        let requests = JSON.parse(localStorage.getItem('ams_requests')) || [];
        let currentUser = null;
        let chartInstance = null;

        // --- AUTH LOGIC ---
        function init() {
            if(sessionStorage.getItem('ams_user')) {
                currentUser = JSON.parse(sessionStorage.getItem('ams_user'));
                loadDashboard();
            }
        }

        function toggleForms(type) {
            document.getElementById('loginForm').style.display = type === 'login' ? 'block' : 'none';
            document.getElementById('registerForm').style.display = type === 'register' ? 'block' : 'none';
        }

        function handleLogin() {
            const u = document.getElementById('loginUser').value;
            const p = document.getElementById('loginPass').value;
            const user = users.find(x => x.username === u && x.password === p);

            if(user) {
                if(user.role === 'admin' && !user.isApproved) {
                    alert('‚ö†Ô∏è Your Admin account is pending approval from the main administrator.');
                    return;
                }
                currentUser = user;
                sessionStorage.setItem('ams_user', JSON.stringify(user));
                loadDashboard();
            } else {
                alert('Invalid credentials');
            }
        }

        function handleRegister() {
            const name = document.getElementById('regName').value;
            const user = document.getElementById('regUser').value;
            const pass = document.getElementById('regPass').value;
            const role = document.getElementById('regRole').value;

            if(!name || !user || !pass) return alert('Fill all fields');
            if(users.find(x => x.username === user)) return alert('Username taken');

            // Admin Logic: Check if ANY admin exists. If yes, new admin is unapproved.
            let isApproved = true;
            if(role === 'admin') {
                const existingAdmin = users.find(u => u.role === 'admin' && u.isApproved);
                if(existingAdmin) {
                    isApproved = false;
                    alert('‚ö†Ô∏è As an Admin already exists, your account will require approval.');
                }
            }

            const newUser = { id: Date.now(), name, username: user, password: pass, role, isApproved };
            users.push(newUser);
            saveData();
            
            toggleForms('login');
            if(isApproved) {
                alert('Registration successful! Please login.');
            }
        }

        function logout() {
            sessionStorage.removeItem('ams_user');
            location.reload();
        }

        // --- DASHBOARD RENDERING ---
        function loadDashboard() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('dashboard').classList.add('active');
            document.getElementById('welcomeText').innerText = `Welcome back, ${currentUser.name}`;
            document.getElementById('userInitials').innerText = currentUser.name.charAt(0);
            
            const roleBadge = document.getElementById('userRoleBadge');
            roleBadge.innerText = currentUser.role.toUpperCase();
            roleBadge.className = `badge ${currentUser.role === 'admin' ? 'badge-warn' : 'badge-avail'}`;

            renderSidebar();
            
            if(currentUser.role === 'admin') {
                navTo('sec-dashboard');
            } else {
                navTo('sec-myassets');
            }
        }

        function renderSidebar() {
            const menu = document.getElementById('sidebarMenu');
            let html = '';

            if(currentUser.role === 'admin') {
                html += `<div class="nav-item" onclick="navTo('sec-dashboard')">üìä Dashboard</div>`;
                html += `<div class="nav-item" onclick="navTo('sec-inventory')">üì¶ Inventory</div>`;
                html += `<div class="nav-item" onclick="navTo('sec-requests')">üì® Requests</div>`;
                html += `<div class="nav-item" onclick="navTo('sec-users')">üë• Users</div>`;
            } else {
                html += `<div class="nav-item" onclick="navTo('sec-myassets')">üéí My Assets</div>`;
                html += `<div class="nav-item" onclick="navTo('sec-requests')">üì® My Requests</div>`;
            }
            html += `<div class="nav-item" onclick="navTo('sec-profile')">üë§ Profile</div>`;
            menu.innerHTML = html;
        }

        function navTo(secId) {
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.getElementById(secId).classList.add('active');
            
            // Refresh data based on view
            if(secId === 'sec-dashboard') updateStatsAndChart();
            if(secId === 'sec-inventory') renderInventory();
            if(secId === 'sec-myassets') renderMyAssets();
            if(secId === 'sec-requests') renderRequests();
            if(secId === 'sec-users') renderUsers();
            if(secId === 'sec-profile') loadProfile();
        }

        // --- ADMIN: DASHBOARD & CHARTS ---
        function updateStatsAndChart() {
            const total = assets.length;
            const assigned = assets.filter(a => a.status === 'In-Use').length;
            const avail = assets.filter(a => a.status === 'Available').length;
            const damaged = assets.filter(a => a.status === 'Damaged' || a.status === 'Maintenance').length;
            const pending = requests.filter(r => r.status === 'Pending').length;

            document.getElementById('statTotal').innerText = total;
            document.getElementById('statAssigned').innerText = assigned;
            document.getElementById('statAvail').innerText = avail;
            document.getElementById('statRequests').innerText = pending;

            const ctx = document.getElementById('assetChart').getContext('2d');
            if(chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Available', 'In-Use', 'Damaged/Maint', 'Lost'],
                    datasets: [{
                        data: [
                            avail, 
                            assigned, 
                            damaged,
                            assets.filter(a => a.status === 'Lost').length
                        ],
                        backgroundColor: ['#10b981', '#3b82f6', '#f59e0b', '#ef4444'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', labels: { color: 'white' } }
                    }
                }
            });
        }

        // --- ASSET MANAGEMENT (CRUD) ---
        function renderInventory(search = '') {
            const tbody = document.querySelector('#inventoryTable tbody');
            tbody.innerHTML = '';
            
            const filtered = assets.filter(a => a.name.toLowerCase().includes(search.toLowerCase()));

            filtered.forEach(asset => {
                const assignedUser = users.find(u => u.id === asset.assignedTo);
                const userName = assignedUser ? assignedUser.name : '-';
                
                let badgeClass = 'badge-avail';
                if(asset.status === 'In-Use') badgeClass = 'badge-busy';
                if(asset.status === 'Damaged' || asset.status === 'Lost') badgeClass = 'badge-bad';

                let actions = `
                    <button class="action-btn btn-blue" onclick="editAsset(${asset.id})">Edit</button>
                    <button class="action-btn" onclick="viewHistory(${asset.id})">Logs</button>
                `;

                if(asset.status === 'Available') {
                    actions += `<button class="action-btn" style="background:#10b981" onclick="openAssignModal(${asset.id})">Assign</button>`;
                } else if(asset.status === 'In-Use') {
                    actions += `<button class="action-btn" style="background:#f59e0b" onclick="adminReturnAsset(${asset.id})">Return</button>`;
                }

                const tr = `
                    <tr>
                        <td>${asset.name}</td>
                        <td>${asset.type}</td>
                        <td><span class="badge ${badgeClass}">${asset.status}</span></td>
                        <td>${userName}</td>
                        <td>${actions}</td>
                    </tr>
                `;
                tbody.innerHTML += tr;
            });
        }

        function openAssetModal() {
            document.getElementById('assetId').value = '';
            document.getElementById('assetName').value = '';
            document.getElementById('assetStatus').value = 'Available';
            document.getElementById('assetModal').classList.add('show');
        }

        function editAsset(id) {
            const asset = assets.find(a => a.id === id);
            document.getElementById('assetId').value = asset.id;
            document.getElementById('assetName').value = asset.name;
            document.getElementById('assetType').value = asset.type;
            document.getElementById('assetStatus').value = asset.status;
            document.getElementById('assetModal').classList.add('show');
        }

        function saveAsset() {
            const id = document.getElementById('assetId').value;
            const name = document.getElementById('assetName').value;
            const type = document.getElementById('assetType').value;
            const status = document.getElementById('assetStatus').value;

            if(id) {
                // Edit
                const asset = assets.find(a => a.id == id);
                // Log status change
                if(asset.status !== status) addLog(asset.id, `Status changed from ${asset.status} to ${status}`);
                asset.name = name;
                asset.type = type;
                asset.status = status;
                // If status changed to Available manually, unassign
                if(status === 'Available') asset.assignedTo = null;
            } else {
                // New
                const newAsset = {
                    id: Date.now(),
                    name, type, status,
                    assignedTo: null,
                    history: []
                };
                newAsset.history.push({date: new Date().toLocaleDateString(), action: 'Created', user: currentUser.name});
                assets.push(newAsset);
            }
            saveData();
            closeModal('assetModal');
            if(currentUser.role === 'admin') updateStatsAndChart(); // refresh chart
            renderInventory();
        }

        // --- ASSIGNMENT LOGIC ---
        function openAssignModal(assetId) {
            const asset = assets.find(a => a.id === assetId);
            document.getElementById('assignAssetId').value = assetId;
            document.getElementById('assignAssetName').innerText = asset.name;
            
            const select = document.getElementById('assignUserSelect');
            select.innerHTML = '';
            users.filter(u => u.role === 'employee').forEach(u => {
                select.innerHTML += `<option value="${u.id}">${u.name} (${u.username})</option>`;
            });
            
            document.getElementById('assignModal').classList.add('show');
        }

        function processAssignment() {
            const assetId = document.getElementById('assignAssetId').value;
            const userId = document.getElementById('assignUserSelect').value;
            const asset = assets.find(a => a.id == assetId);
            const user = users.find(u => u.id == userId);

            asset.assignedTo = parseInt(userId);
            asset.status = 'In-Use';
            addLog(asset.id, `Assigned to ${user.name} by Admin`);
            
            saveData();
            closeModal('assignModal');
            renderInventory();
            updateStatsAndChart();
        }

        function adminReturnAsset(assetId) {
            if(!confirm('Confirm return of this asset?')) return;
            const asset = assets.find(a => a.id == assetId);
            const user = users.find(u => u.id === asset.assignedTo);
            
            asset.assignedTo = null;
            asset.status = 'Available';
            addLog(asset.id, `Returned from ${user ? user.name : 'Unknown'}`);
            
            saveData();
            renderInventory();
            updateStatsAndChart();
        }

        // --- EMPLOYEE FEATURES ---
        function renderMyAssets() {
            const tbody = document.querySelector('#myAssetsTable tbody');
            tbody.innerHTML = '';
            
            const myAssets = assets.filter(a => a.assignedTo === currentUser.id);

            if(myAssets.length === 0) tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding: 2rem;">No assets assigned</td></tr>';

            myAssets.forEach(asset => {
                tbody.innerHTML += `
                    <tr>
                        <td>${asset.name} <br> <small style="color:#94a3b8">${asset.type}</small></td>
                        <td>${asset.history.find(h=>h.action.includes('Assigned'))?.date || 'N/A'}</td>
                        <td>${asset.status}</td>
                        <td>
                            <button class="action-btn btn-blue" onclick="openRequestModal('return', ${asset.id})">Return / Report</button>
                        </td>
                    </tr>
                `;
            });
        }

        function openRequestModal(type, assetId = null) {
            document.getElementById('reqType').value = type;
            document.getElementById('reqAssetId').value = assetId || '';
            document.getElementById('reqModalTitle').innerText = type === 'issue' ? 'Request New Asset' : 'Return / Report Damage';
            
            // If return, hide name input, auto-fill from JS logic not needed for UI simplicity, just hide text input
            if(type === 'return') {
                const asset = assets.find(a => a.id === assetId);
                document.getElementById('reqAssetName').value = asset.name;
                document.getElementById('reqAssetName').disabled = true;
            } else {
                document.getElementById('reqAssetName').value = '';
                document.getElementById('reqAssetName').disabled = false;
            }
            
            document.getElementById('reqReason').value = '';
            document.getElementById('requestModal').classList.add('show');
        }

        function submitRequest() {
            const type = document.getElementById('reqType').value;
            const assetId = document.getElementById('reqAssetId').value;
            const name = document.getElementById('reqAssetName').value;
            const reason = document.getElementById('reqReason').value;

            const req = {
                id: Date.now(),
                userId: currentUser.id,
                userName: currentUser.name,
                type: type, // 'issue' or 'return'
                assetName: name, // For issue: Requested Item. For return: Actual Asset Name
                relatedAssetId: assetId,
                reason: reason,
                date: new Date().toLocaleDateString(),
                status: 'Pending'
            };

            requests.push(req);
            saveData();
            closeModal('requestModal');
            alert('Request sent successfully');
            if(currentUser.role === 'employee') renderRequests(); // Employee view
        }

        // --- REQUEST MANAGEMENT ---
        function renderRequests() {
            const tbody = document.querySelector('#requestsTable tbody');
            tbody.innerHTML = '';

            let displayReqs = requests;
            // Employees only see their own
            if(currentUser.role === 'employee') {
                displayReqs = requests.filter(r => r.userId === currentUser.id);
            }

            displayReqs.sort((a,b) => b.id - a.id).forEach(r => {
                let actions = '';
                if(currentUser.role === 'admin' && r.status === 'Pending') {
                    actions = `
                        <button class="action-btn" style="background:#10b981" onclick="handleRequest(${r.id}, 'Approved')">Approve</button>
                        <button class="action-btn btn-danger" onclick="handleRequest(${r.id}, 'Rejected')">Reject</button>
                    `;
                } else {
                    actions = `<span class="badge ${r.status === 'Approved' ? 'badge-avail' : (r.status === 'Rejected' ? 'badge-bad' : 'badge-warn')}">${r.status}</span>`;
                }

                tbody.innerHTML += `
                    <tr>
                        <td>${r.userName}</td>
                        <td>${r.type.toUpperCase()}</td>
                        <td>${r.assetName}<br><small>${r.reason}</small></td>
                        <td>${r.date}</td>
                        <td><span class="badge badge-warn">${r.status}</span></td>
                        <td>${actions}</td>
                    </tr>
                `;
            });
        }

        function handleRequest(reqId, action) {
            const req = requests.find(r => r.id === reqId);
            req.status = action;

            if(action === 'Approved') {
                if(req.type === 'return' && req.relatedAssetId) {
                    // Process return logic automatically
                    const asset = assets.find(a => a.id == req.relatedAssetId);
                    if(asset) {
                        asset.assignedTo = null;
                        asset.status = 'Available'; // Or 'Maintenance' based on reason (simplified here)
                        addLog(asset.id, `Return Approved. Notes: ${req.reason}`);
                    }
                }
                // For 'issue', Admin still needs to manually assign an asset via Inventory, 
                // but marking request as approved acknowledges it.
            }
            
            saveData();
            renderRequests();
            updateStatsAndChart();
        }

        // --- USER MANAGEMENT ---
        function renderUsers() {
            const tbody = document.querySelector('#usersTable tbody');
            tbody.innerHTML = '';

            users.forEach(u => {
                const assetCount = assets.filter(a => a.assignedTo === u.id).length;
                let statusBadge = u.isApproved ? '<span class="badge badge-avail">Active</span>' : '<span class="badge badge-warn">Pending Approval</span>';
                
                let action = '';
                if(!u.isApproved && currentUser.role === 'admin') {
                    action = `<button class="action-btn btn-success" onclick="approveAdmin(${u.id})">Approve Admin</button>`;
                }

                tbody.innerHTML += `
                    <tr>
                        <td>${u.name}</td>
                        <td>${u.username}</td>
                        <td>${u.role.toUpperCase()}</td>
                        <td>${assetCount}</td>
                        <td>${statusBadge}</td>
                        <td>${action}</td>
                    </tr>
                `;
            });
        }

        function approveAdmin(userId) {
            const u = users.find(x => x.id === userId);
            u.isApproved = true;
            saveData();
            renderUsers();
            alert(`User ${u.name} is now an active Admin.`);
        }

        function loadProfile() {
            document.getElementById('profileName').value = currentUser.name;
        }

        function updateProfile() {
            const newName = document.getElementById('profileName').value;
            const newPass = document.getElementById('profilePass').value;

            const u = users.find(x => x.id === currentUser.id);
            u.name = newName;
            if(newPass) u.password = newPass;

            currentUser = u; // Update session ref
            sessionStorage.setItem('ams_user', JSON.stringify(u));
            saveData();
            alert('Profile updated!');
            document.getElementById('welcomeText').innerText = `Welcome back, ${u.name}`;
        }

        // --- HELPERS ---
        function addLog(assetId, action) {
            const asset = assets.find(a => a.id == assetId);
            if(!asset.history) asset.history = [];
            asset.history.unshift({
                date: new Date().toLocaleDateString() + ' ' + new Date().toLocaleTimeString(),
                action: action,
                user: currentUser.name
            });
        }

        function viewHistory(assetId) {
            const asset = assets.find(a => a.id == assetId);
            const container = document.getElementById('historyContent');
            container.innerHTML = '';
            
            if(!asset.history || asset.history.length === 0) {
                container.innerHTML = '<p>No history recorded.</p>';
            } else {
                asset.history.forEach(h => {
                    container.innerHTML += `
                        <div style="padding: 0.5rem; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 0.9rem;">
                            <div style="color: var(--primary); font-size: 0.8rem;">${h.date} - ${h.user}</div>
                            <div>${h.action}</div>
                        </div>
                    `;
                });
            }
            document.getElementById('historyModal').classList.add('show');
        }

        function saveData() {
            localStorage.setItem('ams_users', JSON.stringify(users));
            localStorage.setItem('ams_assets', JSON.stringify(assets));
            localStorage.setItem('ams_requests', JSON.stringify(requests));
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('show');
        }

        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('show');
            }
        }

        // Start
        window.onload = init;

    </script>
</body>
</html>
